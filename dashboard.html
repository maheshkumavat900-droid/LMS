<!doctype html><html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Smart LMS â€” Student</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"><link href="style.css" rel="stylesheet"></head>
<body>
<nav class="navbar px-3"><a class="navbar-brand" href="#">ðŸ“š Smart LMS</a>
  <div class="d-flex align-items-center gap-2"><button class="btn btn-outline-secondary" onclick="toggleTheme()">ðŸŒ“</button><input class="form-control" id="q" placeholder="Search books..." oninput="render()"><button class="btn btn-primary" onclick="logout()">Logout</button></div></nav>
<div class="container py-4"><div id="alert"></div><div class="row g-4">
  <div class="col-lg-8">
    <div class="card p-3 mb-4"><div class="d-flex justify-content-between align-items-center"><h5 class="mb-2">Available Books</h5><span class="small-muted">Managed by Admin</span></div>
      <div class="table-responsive"><table class="table table-striped table-hover align-middle"><thead class="table-light"><tr><th>#</th><th>Title</th><th>Author</th><th>Category</th><th>Available</th><th></th></tr></thead><tbody id="rows"></tbody></table></div>
    </div>
    <div class="card p-3"><h5 class="mb-2">My Issued Books</h5>
      <div class="table-responsive"><table class="table table-striped table-hover align-middle"><thead class="table-light"><tr><th>#</th><th>Title</th><th>Issued</th><th>Submit (To)</th><th>Returned</th><th>Status</th><th>Fine</th><th></th></tr></thead><tbody id="myrows"></tbody></table></div>
      <div class="mt-3" id="reco"></div>
    </div>
  </div>
  <div class="col-lg-4">
    <div class="card p-3"><h5 class="mb-2">Your Details</h5><div><b>Name:</b> <span id="s_name"></span></div><div><b>Email:</b> <span id="s_email"></span></div><div><b>Enrollment:</b> <span id="s_enroll"></span></div></div>
    <div class="card p-3 mt-4"><h5 class="mb-2">Suggest a New Book</h5>
      <form class="vstack gap-2" onsubmit="return suggestBook(event)"><input class="form-control" id="req_title" placeholder="Title" required><input class="form-control" id="req_author" placeholder="Author" required><input class="form-control" id="req_cat" placeholder="Category (optional)"><button class="btn btn-primary">Submit Request</button><div class="small-muted">Goes to Admin for approval</div></form>
    </div>
    <div class="card p-3 mt-4"><h6 class="mb-2">My Book Requests</h6>
      <div class="table-responsive"><table class="table table-sm"><thead class="table-light"><tr><th>Title</th><th>Status</th></tr></thead><tbody id="reqrows"></tbody></table></div>
    </div>
  </div>
</div></div>

<!-- Issue Modal (manual submit date) -->
<div class="modal fade" id="issueModal" tabindex="-1" aria-hidden="true"><div class="modal-dialog"><div class="modal-content">
  <div class="modal-header"><h5 class="modal-title">Issue Book</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
  <div class="modal-body vstack gap-3">
    <div><label class="form-label">Enrollment No (required)</label><input id="enrollInput" class="form-control" required></div>
    <div class="row g-2"><div class="col-6"><label class="form-label">Issue Date</label><input type="date" id="fromDate" class="form-control" required></div><div class="col-6"><label class="form-label">Submit Date (To)</label><input type="date" id="toDate" class="form-control" required></div></div>
    <div>Book: <b id="issueBookTitle"></b></div>
    <div class="small-muted">Late after <b>Submit Date</b> â†’ â‚¹10/day (1-day grace)</div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button class="btn btn-primary" onclick="confirmIssue()">Issue</button></div>
</div></div></div>

<script src="shared.js"></script>
<script>
initTheme(); seedBooksIfEmpty();
const PAGE_SIZE=999; let issueModal; let selectedBookId=null;
function ensureAuth(){ const u=session(); if(!u){ location='index.html'; return; } if(u.role!=='STUDENT'){ location='admin.html'; return; } s_name.textContent=u.name; s_email.textContent=u.email; s_enroll.textContent=u.enroll || '(not set)'; }
function logout(){ localStorage.removeItem(SESSION_KEY); location='index.html'; }
function render(){ const q=document.getElementById('q').value?.toLowerCase()||''; const b=books().filter(x=>!q || x.title.toLowerCase().includes(q) || x.author.toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q)); rows.innerHTML=''; let i=1; b.slice(0,PAGE_SIZE).forEach(x=>{ rows.insertAdjacentHTML('beforeend',`<tr><td>${i++}</td><td>${x.title}</td><td>${x.author}</td><td>${x.category||''}</td><td><span class="badge bg-${x.available>0?'success':'secondary'}">${x.available}</span></td><td><button class="btn btn-sm btn-primary neon" ${x.available<=0?'disabled':''} onclick="openIssue(${x.id}, '${x.title.replace(/'/g,"\'")}')">Issue</button></td></tr>`); }); renderMy(); renderRequests(); }
function renderMy(){ const u=session(); const list=issues().filter(x=>x.userEmail===u.email).sort((a,b)=>b.id-a.id); myrows.innerHTML=''; let i=1,total=0; const t=todayISO(); list.forEach(m=>{ const calc = m.returnDate ? computeFineWithGrace(m.toDate, m.returnDate) : computeFineWithGrace(m.toDate, t); const fine = m.returnDate ? m.fine||calc.fine : calc.fine; total+=fine; const status = m.returnDate ? (calc.fine>0?'Returned (Late)':'Returned') : (calc.fine>0?'Overdue':'Issued'); const dueIn = Math.ceil((parseDate(m.toDate)-parseDate(t))/86400000); const extra = (!m.returnDate && dueIn===1) ? "<span class='badge bg-warning text-dark ms-1'>Due Tomorrow</span>" : ""; const actions = m.returnDate ? `<a class='btn btn-sm btn-outline-secondary' href='bill.html?issueId=${m.id}' target='_blank'>Bill</a>` : `<button class='btn btn-sm btn-outline-secondary me-2' ${ (m.renewals||0)>=1 ? 'disabled' : '' } onclick='renew(${m.id})'>Renew +3d</button><button class='btn btn-sm btn-outline-primary' onclick='returnBook(${m.id})'>Return</button>`; myrows.insertAdjacentHTML('beforeend',`<tr><td>${i++}</td><td>${m.bookTitle}</td><td>${m.fromDate}</td><td>${m.toDate} ${extra}</td><td>${m.returnDate||'-'}</td><td>${status}</td><td>â‚¹${fine}</td><td>${actions}</td></tr>`); }); alert.innerHTML = `<div class="alert alert-info">Total potential fines: <b>â‚¹${total}</b></div>`; if(list.length){ const last = list[0]; const b = books().find(x=>x.id===last.bookId) || {category:''}; const rec = books().filter(x=> x.title!==last.bookTitle && (x.category||'')===(b.category||'')).slice(0,3); reco.innerHTML = rec.length ? `<div class="mt-2"><b>Recommended:</b> ${rec.map(x=>`<span class="badge bg-light text-dark me-2">${x.title}</span>`).join(' ')}</div>` : ''; } else { reco.innerHTML=''; } }
function openIssue(id, title){ const u=session(); selectedBookId=id; issueBookTitle.textContent=title; enrollInput.value=(u.enroll||'').trim(); const t=todayISO(); fromDate.value=t; toDate.value=new Date(Date.now()+7*86400000).toISOString().slice(0,10); issueModal = new bootstrap.Modal(document.getElementById('issueModal')); issueModal.show(); }
function confirmIssue(){ const u=session(); const b=books(); const i=issues(); const bk=b.find(x=>x.id===selectedBookId); if(!bk || bk.available<=0) return toast('Not available'); const enroll=enrollInput.value.trim(); const from=fromDate.value; const to=toDate.value; if(!enroll) return toast('Enrollment required'); if(!from||!to) return toast('Select both dates'); if(parseDate(to)<parseDate(from)) return toast('Submit Date must be after Issue Date'); u.enroll=enroll; setSession(u); const rec = {id:Date.now(), bookId:bk.id, bookTitle:bk.title, userName:u.name, userEmail:u.email, enrollment:enroll, fromDate:from, toDate:to, returnDate:null, fine:0, renewals:0}; bk.available--; setBooks(b); const arr=i; arr.push(rec); setIssues(arr); issueModal.hide(); toast('Book issued!'); render(); }
function renew(issueId){ const arr=issues(); const rec=arr.find(x=>x.id===issueId && !x.returnDate); if(!rec) return; if((rec.renewals||0)>=1){ toast('Renewal limit reached'); return; } rec.toDate = new Date(parseDate(rec.toDate).getTime() + 3*86400000).toISOString().slice(0,10); rec.renewals = (rec.renewals||0)+1; setIssues(arr); toast('Renewed +3 days'); render(); }
function returnBook(issueId){ const b=books(); const arr=issues(); const rec=arr.find(x=>x.id===issueId && !x.returnDate); if(!rec) return; rec.returnDate=todayISO(); const calc=computeFineWithGrace(rec.toDate, rec.returnDate); rec.fine=calc.fine; rec.lateDays=calc.lateDays; rec.chargeDays=calc.chargeableDays; const bk=b.find(x=>x.id===rec.bookId); if(bk) bk.available++; setBooks(b); setIssues(arr); toast(calc.fine>0?`Returned late by ${calc.lateDays}d. Fine â‚¹${calc.fine}.`:'Returned on time.'); window.open('bill.html?issueId='+issueId,'_blank'); render(); }
function suggestBook(e){ e.preventDefault(); const u=session(); const r = requests(); const rec = { id: Date.now(), title: req_title.value.trim(), author: req_author.value.trim(), category: req_cat.value.trim(), by: u.email, status: 'PENDING' }; r.push(rec); setRequests(r); e.target.reset(); renderRequests(); toast('Request submitted'); return false; }
function renderRequests(){ const u=session(); const list = requests().filter(x=>x.by===u.email).sort((a,b)=>b.id-a.id); reqrows.innerHTML=''; list.forEach(x=>{ const badge=x.status==='PENDING'?'warning':(x.status==='APPROVED'?'success':'secondary'); reqrows.insertAdjacentHTML('beforeend',`<tr><td>${x.title}</td><td><span class="badge bg-${badge}">${x.status}</span></td></tr>`); }); }
function ensureAuthAndInit(){ ensureAuth(); render(); } ensureAuthAndInit();
</script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script></body></html>